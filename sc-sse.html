<link rel="import" href="../polymer/polymer.html">


<!--
sc-sse is a non-visual Web Component that receives HTML Server-Sent Events (SSE)
on the client side.

about SSE see:
 https://html.spec.whatwg.org/multipage/comms.html#server-sent-events
 http://www.html5rocks.com/en/tutorials/eventsource/basics/
 
##### Example

    <sc-sse stream="/stream/" event="message" alias="updates"></sc-sse>

@element sc-sse
@blurb non-visual Custom Element that consumes Server-Sent Events (SSE)
@status beta
@homepage http://github.com/siscomando/sc-sse
-->
<polymer-element name="sc-sse" hidden attributes="notitle author stream event alias">
  <script>
    'use strict'

    Polymer('sc-sse', { 
       /**
       * Fires when an event is received from Server-Sent Event stream.
       *
       *
       * @event sc-sse-response
       */        
      /**
       * The `author` attribute sets an initial author
       *
       * @attribute author
       * @type String
       * @default 'Horacio Ibrahim'
       */ 
      author: 'Horacio Ibrahim', 
      /**
       * The `alias` is name for recognize one of multiple sc-sse element fired.
       *
       * @attribute alias
       * @type String
       * @default default
       */       
      /**
       * The `stream` attribute sets an url to get updates
       *
       * @attribute stream
       * @type String
       * @default ''
       */                   
      publish: {
        stream: '',
        event: 'message',
        alias: 'default'
      },
      
      sender: '',
      
      ready: function() {
        var stream = this.stream;
        var callback = this.fire;
        var event = this.event;
        var that = this;
        
        // prep security check: extract protocol (http[s]:) and host from URL
        var m= getLocation(stream)
        this.sender= m.protocol +'//' +m.host

        try {
          var source = new EventSource(stream);  
          this.makeRead(source, event, callback, that);
        } catch (x) {
          console.warn('sc-sse: failed to create EventSource ' +x);
        }
      },
      /**
       * `makeRead` opens connection to SSE stream and installs event handler client.
       *
       * 
       * @method makeRead
       * @param source an instance of EventSource
       * @param event an event type 
       * @param callback a callback that works with Polymer objects
       * @param that points to current Polymer element
       */       
      makeRead: function(source, event, callback, that) {
        source.addEventListener(event, function(e) {
          if (e.origin != that.sender)
            console.log("sc-sse: discarding event from alien source " +e.origin)
          else
            callback('sc-sse-response', {response:e.data, alias:that.alias}, that);
        });
      },
    });
    
    // from http://stackoverflow.com/questions/736513/how-do-i-parse-a-url-into-hostname-and-path-in-javascript
    function getLocation(href) {
      var match = href.match(/^(https?\:)\/\/(([^:\/?#]*)(?:\:([0-9]+))?)(\/[^?#]*)(\?[^#]*|)(#.*|)$/);
      return match && {
          protocol: match[1],
          host: match[2],
          hostname: match[3],
          port: match[4],
          pathname: match[5],
          search: match[6],
          hash: match[7]
      }
    }
  </script>

</polymer-element>
